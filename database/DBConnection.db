package com.atg.database;

import java.io.File;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;

public class DBConnection {

    // Database file name (created in project root or JAR working directory)
    private static final String DB_FILE = "atg_database.db";
    private static final String DB_URL = "jdbc:sqlite:" + DB_FILE;

    // --- Main connection method ---
    public static Connection getConnection() {
        Connection conn = null;
        try {
            File dbFile = new File(DB_FILE);
            System.out.println("üìÅ Using database: " + dbFile.getAbsolutePath());

            conn = DriverManager.getConnection(DB_URL);
            System.out.println("‚úÖ Connected to SQLite database successfully!");

            // Auto-create required tables if not exist
            createTables(conn);

        } catch (SQLException e) {
            System.err.println("‚ùå Database connection failed: " + e.getMessage());
        }
        return conn;
    }

    // --- Create tables automatically ---
    private static void createTables(Connection conn) {
        try (Statement stmt = conn.createStatement()) {

            // 1Ô∏è‚É£ Institute Configuration Table
            stmt.executeUpdate("""
                CREATE TABLE IF NOT EXISTS institute_config (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    department TEXT,
                    start_time TEXT NOT NULL,
                    end_time TEXT NOT NULL,
                    working_days INTEGER NOT NULL,
                    practical_duration INTEGER,
                    lecture_duration INTEGER,
                    working_hours REAL
                );
            """);

            // 2Ô∏è‚É£ Institute Breaks Table
            stmt.executeUpdate("""
                CREATE TABLE IF NOT EXISTS institute_breaks (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    institute_id INTEGER NOT NULL,
                    break_no INTEGER,
                    start_time TEXT,
                    end_time TEXT,
                    FOREIGN KEY (institute_id) REFERENCES institute_config(id) ON DELETE CASCADE
                );
            """);

            System.out.println("‚úÖ Tables verified (created if missing).");

        } catch (SQLException e) {
            System.err.println("‚ö†Ô∏è Error creating tables: " + e.getMessage());
        }
    }

    // --- For quick testing (run directly from IDE) ---
    public static void main(String[] args) {
        getConnection();
    }
}
